<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Specify Players</title>
  <link rel="stylesheet" href="/frontend/style.css">
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    .booking-container {
      position: relative;
      top: auto;
      left: auto;
      transform: none;
      max-width: 100%;
      width: 100%;
      padding: 0;
      min-height: 100vh;
      background: #fff;
      padding-bottom: 140px;
    }
    
    .booking-header {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      background: #fff;
      border-bottom: 1px solid #eee;
    }
    
    .back-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: none;
      font-size: 24px;
      color: #064f32;
      cursor: pointer;
      padding: 0;
    }
    
    .header-info {
      margin-left: 10px;
    }
    
    .club-name {
      font-size: 12px;
      color: #888;
      margin: 0;
    }
    
    .page-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 0;
    }
    
    .selectors {
      display: flex;
      gap: 15px;
      padding: 15px 20px;
      background: #f9f9f9;
    }
    
    .selector-btn {
      flex: 1;
      padding: 15px;
      border: 2px solid #064f32;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      text-align: center;
    }
    
    .selector-btn .main-text {
      font-size: 18px;
      font-weight: 600;
      color: #064f32;
    }
    
    .selector-btn .sub-text {
      font-size: 12px;
      color: #888;
    }
    
    .booking-tabs {
      display: flex;
      justify-content: center;
      padding: 15px 20px;
      gap: 0;
      background: #f9f9f9;
    }
    
    .tab-btn {
      padding: 10px 25px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 14px;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab-btn:first-child {
      border-radius: 20px 0 0 20px;
      border-right: none;
    }
    
    .tab-btn:last-child {
      border-radius: 0 20px 20px 0;
    }
    
    .tab-btn.active {
      background: #fff;
      color: #064f32;
      font-weight: 600;
      border-color: #064f32;
    }
    
    .players-section {
      padding: 20px;
    }
    
    .section-title {
      font-size: 16px;
      color: #bbb;
      margin-bottom: 15px;
      font-weight: 400;
    }
    
    .player-card {
      display: flex;
      align-items: center;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 12px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .player-card:hover {
      background: #f0f0f0;
    }
    
    .player-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e0e0e0, #c0c0c0);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 20px;
      color: #888;
    }
    
    .player-info {
      flex: 1;
    }
    
    .player-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 3px;
    }
    
    .player-type {
      font-size: 14px;
      color: #666;
    }
    
    .player-price {
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }
    
    .player-price .currency {
      font-size: 14px;
      color: #666;
      vertical-align: super;
    }
    
    .modify-text {
      font-size: 12px;
      color: #ccc;
      font-style: italic;
      margin-top: 8px;
      text-align: center;
    }
    
    .add-player-btn {
      display: inline-flex;
      align-items: center;
      padding: 10px 20px;
      border: 1px solid #064f32;
      border-radius: 20px;
      background: #fff;
      color: #064f32;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .add-player-btn:hover {
      background: #f0f7f4;
    }
    
    /* Bottom bar */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      padding: 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .total-section {
      flex: 1;
    }
    
    .total-label {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }
    
    .total-price {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }
    
    .total-price .currency {
      font-size: 16px;
      color: #666;
    }
    
    .free-cancel {
      font-size: 12px;
      color: #064f32;
      font-weight: 600;
    }
    
    .continue-btn {
      padding: 18px 50px;
      background: #064f32;
      color: #fff;
      border: none;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .continue-btn:hover {
      background: #0b6e47;
    }
    
    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: #fff;
      border-radius: 15px;
      padding: 25px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .modal-close {
      width: 30px;
      height: 30px;
      border: none;
      background: #f0f0f0;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      color: #666;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .price-display {
      font-size: 20px;
      font-weight: 700;
      color: #064f32;
      text-align: center;
      padding: 15px;
      background: #f0f7f4;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .modal-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 10px;
    }
    
    .btn-primary {
      background: #064f32;
      color: #fff;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    .btn-danger {
      background: #dc3545;
      color: #fff;
    }
    
    .player-type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .type-option {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .type-option:hover,
    .type-option.selected {
      border-color: #064f32;
      background: #f0f7f4;
    }
    
    .type-option .type-name {
      font-weight: 600;
      color: #333;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #888;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="booking-container">
    <div class="booking-header">
      <button class="back-btn" onclick="goBack()">â€¹</button>
      <div class="header-info">
        <p class="club-name">Golf Club</p>
        <h1 class="page-title">Specify Players</h1>
      </div>
    </div>
    
    <div class="selectors">
      <div class="selector-btn">
        <div class="main-text" id="selected-day">Thursday</div>
        <div class="sub-text" id="selected-date"></div>
      </div>
      <div class="selector-btn">
        <div class="main-text" id="selected-time">12:50 PM</div>
        <div class="sub-text" id="holes-info"></div>
      </div>
    </div>
    
    <div class="booking-tabs">
      <button class="tab-btn active" onclick="setTab('book')">Book for Players</button>
      <button class="tab-btn" onclick="setTab('invite')">Invite Players</button>
    </div>
    
    <div class="players-section">
      <h3 class="section-title">Ready to Book</h3>
      <div id="players-list">
        <!-- Players will be loaded here -->
      </div>
      <button class="add-player-btn" onclick="openAddPlayerModal()">Add player</button>
    </div>
  </div>
  
  <div class="bottom-bar">
    <div class="total-section">
      <div class="total-label">Total Booking Rate</div>
      <div class="total-price"><span class="currency">R</span><span id="total-amount">0</span></div>
      <div class="free-cancel">FREE Cancellation</div>
    </div>
    <button class="continue-btn" onclick="confirmBookings()">Continue Â»</button>
  </div>

  <!-- Add Player Modal -->
  <div class="modal-overlay" id="addPlayerModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Add Player</span>
        <button class="modal-close" onclick="closeModal('addPlayerModal')">Ã—</button>
      </div>
      
      <div class="player-type-selector">
        <div class="type-option selected" onclick="selectPlayerType('member')" id="type-member">
          <div class="type-name">Member</div>
        </div>
        <div class="type-option" onclick="selectPlayerType('guest')" id="type-guest">
          <div class="type-name">Guest</div>
        </div>
        <div class="type-option" onclick="selectPlayerType('visitor')" id="type-visitor">
          <div class="type-name">Visitor</div>
        </div>
      </div>
      
      <div class="form-group">
        <label>Player Name *</label>
        <input type="text" id="player_name" placeholder="Enter player name">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="player_email" placeholder="Enter email">
      </div>
      <div class="form-group">
        <label>Membership / Handicap Number</label>
        <input type="text" id="player_handicap" placeholder="e.g. 5409">
      </div>
      <div class="form-group">
        <label>Fee Type *</label>
        <select id="player_fee" onchange="updateModalPrice()">
          <option value="">Select fee type</option>
        </select>
      </div>
      <div class="price-display" id="modal_price">Select a fee type</div>
      <button class="modal-btn btn-primary" onclick="addPlayer()">Add Player</button>
    </div>
  </div>

  <!-- Edit Player Modal -->
  <div class="modal-overlay" id="editPlayerModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Modify Player</span>
        <button class="modal-close" onclick="closeModal('editPlayerModal')">Ã—</button>
      </div>
      <div id="editPlayerBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

<script>
const API_PREFIX = '/tsheet';
const token = localStorage.getItem('token');
if(!token) location.href='/frontend/index.html';

// Get tee time info from URL params
const urlParams = new URLSearchParams(window.location.search);
const teeTimeId = urlParams.get('tee_time_id');
const teeTimeStr = urlParams.get('tee_time');

let players = [];
let golfFees = [];
let selectedPlayerType = 'member';
let existingBookings = [];

// Initialize
async function init() {
  if (!teeTimeId) {
    alert('No tee time selected');
    goBack();
    return;
  }
  
  // Display tee time info
  if (teeTimeStr) {
    const teeDate = new Date(teeTimeStr);
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    document.getElementById('selected-day').textContent = days[teeDate.getDay()];
    document.getElementById('selected-date').textContent = formatDate(teeDate);
    document.getElementById('selected-time').textContent = formatTime(teeDate);
    document.getElementById('holes-info').textContent = '18 Holes';
  }
  
  await loadFees();
  await loadExistingBookings();
  renderPlayers();
}

function formatDate(date) {
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
}

function formatTime(date) {
  let hours = date.getHours();
  let minutes = date.getMinutes();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12;
  return `${hours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
}

async function loadFees() {
  try {
    const res = await fetch('/fees/golf', { headers: { 'Authorization': 'Bearer ' + token }});
    if (res.ok) {
      golfFees = await res.json();
      populateFeeDropdown();
    }
  } catch(e) {
    console.error('Failed to load fees:', e);
  }
}

function populateFeeDropdown() {
  const select = document.getElementById('player_fee');
  select.innerHTML = '<option value="">Select fee type</option>';
  golfFees.forEach(f => {
    select.innerHTML += `<option value="${f.id}" data-price="${f.price}">${f.description} - R${f.price}</option>`;
  });
}

async function loadExistingBookings() {
  try {
    const res = await fetch(`/tsheet/bookings/${teeTimeId}`, { headers: { 'Authorization': 'Bearer ' + token }});
    if (res.ok) {
      existingBookings = await res.json();
      // Convert existing bookings to players format
      existingBookings.forEach(b => {
        players.push({
          id: b.id,
          name: b.player_name,
          email: b.player_email,
          type: b.fee_category_id ? 'Member' : 'Guest',
          handicap: b.handicap_number || '',
          price: b.price,
          feeId: b.fee_category_id,
          isExisting: true,
          status: b.status
        });
      });
    }
  } catch(e) {
    console.error('Failed to load bookings:', e);
  }
}

function renderPlayers() {
  const container = document.getElementById('players-list');
  
  if (players.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ‘¤</div>
        <p>No players added yet</p>
        <p>Tap "Add player" to get started</p>
      </div>
    `;
  } else {
    let html = '';
    players.forEach((p, index) => {
      const initials = p.name.split(' ').map(n => n[0]).join('').toUpperCase();
      html += `
        <div class="player-card" onclick="editPlayer(${index})">
          <div class="player-avatar">${initials}</div>
          <div class="player-info">
            <div class="player-name">${p.name}</div>
            <div class="player-type">${p.type}${p.handicap ? ` (${p.handicap})` : ''}</div>
            <div class="modify-text">tap to modify & add rentals</div>
          </div>
          <div class="player-price">
            <span class="currency">R</span>${p.price}
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }
  
  updateTotal();
}

function updateTotal() {
  const total = players.reduce((sum, p) => sum + (parseFloat(p.price) || 0), 0);
  document.getElementById('total-amount').textContent = total.toFixed(0);
}

function goBack() {
  window.location.href = '/frontend/tsheet.html';
}

function setTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
}

function openModal(id) {
  document.getElementById(id).classList.add('active');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

function openAddPlayerModal() {
  if (players.length >= 4) {
    alert('Maximum 4 players per tee time');
    return;
  }
  document.getElementById('player_name').value = '';
  document.getElementById('player_email').value = '';
  document.getElementById('player_handicap').value = '';
  document.getElementById('player_fee').value = '';
  document.getElementById('modal_price').textContent = 'Select a fee type';
  selectedPlayerType = 'member';
  updateTypeSelection();
  openModal('addPlayerModal');
}

function selectPlayerType(type) {
  selectedPlayerType = type;
  updateTypeSelection();
}

function updateTypeSelection() {
  document.querySelectorAll('.type-option').forEach(el => el.classList.remove('selected'));
  document.getElementById('type-' + selectedPlayerType).classList.add('selected');
}

function updateModalPrice() {
  const select = document.getElementById('player_fee');
  const option = select.options[select.selectedIndex];
  const price = option.getAttribute('data-price');
  
  if (price) {
    document.getElementById('modal_price').textContent = `R${price}`;
  } else {
    document.getElementById('modal_price').textContent = 'Select a fee type';
  }
}

function addPlayer() {
  const name = document.getElementById('player_name').value;
  const email = document.getElementById('player_email').value;
  const handicap = document.getElementById('player_handicap').value;
  const feeSelect = document.getElementById('player_fee');
  const feeId = feeSelect.value;
  const price = feeSelect.options[feeSelect.selectedIndex].getAttribute('data-price');
  
  if (!name) {
    alert('Please enter player name');
    return;
  }
  
  if (!feeId) {
    alert('Please select a fee type');
    return;
  }
  
  const typeMap = { member: 'Member', guest: 'Guest', visitor: 'Visitor' };
  
  players.push({
    name: name,
    email: email,
    type: typeMap[selectedPlayerType],
    handicap: handicap,
    price: parseFloat(price),
    feeId: parseInt(feeId),
    isExisting: false
  });
  
  closeModal('addPlayerModal');
  renderPlayers();
}

function editPlayer(index) {
  const player = players[index];
  
  const typeMap = { 'Member': 'member', 'Guest': 'guest', 'Visitor': 'visitor' };
  
  document.getElementById('editPlayerBody').innerHTML = `
    <div class="player-type-selector">
      <div class="type-option ${player.type === 'Member' ? 'selected' : ''}" onclick="updateEditType('member', ${index})">
        <div class="type-name">Member</div>
      </div>
      <div class="type-option ${player.type === 'Guest' ? 'selected' : ''}" onclick="updateEditType('guest', ${index})">
        <div class="type-name">Guest</div>
      </div>
      <div class="type-option ${player.type === 'Visitor' ? 'selected' : ''}" onclick="updateEditType('visitor', ${index})">
        <div class="type-name">Visitor</div>
      </div>
    </div>
    
    <div class="form-group">
      <label>Player Name</label>
      <input type="text" id="edit_name" value="${player.name}">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="edit_email" value="${player.email || ''}">
    </div>
    <div class="form-group">
      <label>Handicap Number</label>
      <input type="text" id="edit_handicap" value="${player.handicap || ''}">
    </div>
    
    <div class="price-display">R${player.price}</div>
    
    <button class="modal-btn btn-primary" onclick="savePlayer(${index})">Save Changes</button>
    ${!player.isExisting ? `<button class="modal-btn btn-danger" onclick="removePlayer(${index})">Remove Player</button>` : ''}
  `;
  
  openModal('editPlayerModal');
}

function updateEditType(type, index) {
  const typeMap = { member: 'Member', guest: 'Guest', visitor: 'Visitor' };
  players[index].type = typeMap[type];
  editPlayer(index);
}

function savePlayer(index) {
  players[index].name = document.getElementById('edit_name').value;
  players[index].email = document.getElementById('edit_email').value;
  players[index].handicap = document.getElementById('edit_handicap').value;
  closeModal('editPlayerModal');
  renderPlayers();
}

function removePlayer(index) {
  if (confirm('Remove this player?')) {
    players.splice(index, 1);
    closeModal('editPlayerModal');
    renderPlayers();
  }
}

async function confirmBookings() {
  // Filter only new players (not existing bookings)
  const newPlayers = players.filter(p => !p.isExisting);
  
  if (newPlayers.length === 0 && existingBookings.length === 0) {
    alert('Please add at least one player');
    return;
  }
  
  // Create bookings for new players
  let successCount = 0;
  for (const player of newPlayers) {
    try {
      const res = await fetch('/tsheet/booking', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          tee_time_id: parseInt(teeTimeId),
          player_name: player.name,
          player_email: player.email || null,
          handicap_number: player.handicap || null,
          fee_category_id: player.feeId
        })
      });
      
      if (res.ok) {
        successCount++;
      } else {
        const error = await res.json();
        console.error('Booking error:', error);
      }
    } catch(e) {
      console.error('Failed to create booking:', e);
    }
  }
  
  if (successCount > 0 || existingBookings.length > 0) {
    alert(`âœ“ ${successCount} booking(s) created successfully!`);
    window.location.href = '/frontend/tsheet.html';
  } else if (newPlayers.length > 0) {
    alert('Failed to create bookings');
  } else {
    window.location.href = '/frontend/tsheet.html';
  }
}

init();
</script>
</body>
</html>
