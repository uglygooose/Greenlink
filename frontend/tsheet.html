<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Umhlali Tee Sheet</title>
  <link rel="stylesheet" href="/frontend/style.css">
  <style>
    :root {
      --ucc-olive: #5a7a3a;
      --ucc-olive-dark: #4e6a31;
      --ucc-sage: #e6ecd6;
      --ucc-cream: #f6f4ec;
      --ucc-orange: #f28c2c;
      --ucc-gold: #f5c542;
      --ucc-ink: #1f2a1b;
      --ucc-muted: #6c7b66;
      --ucc-border: #d9dfc9;
      --ucc-card: #ffffff;
      --ucc-shadow: 0 12px 30px rgba(31, 42, 27, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #f6f4ec 0%, #e6ecd6 45%, #f6f4ec 100%);
      min-height: 100vh;
      color: var(--ucc-ink);
      font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
    }

    body.embedded {
      background: #f6f4ec;
    }

    body.embedded .tsheet-header,
    body.embedded .selectors,
    body.embedded .sheet-actions .non-embed {
      display: none;
    }

    body.embedded .tsheet-container {
      max-width: 100%;
      width: 100%;
      margin: 0;
      padding: 16px;
    }

    body.embedded .empty-state .action-btn {
      display: none;
    }

    body.player .admin-only {
      display: none !important;
    }

    .tsheet-container {
      position: relative;
      top: auto;
      left: auto;
      transform: none;
      max-width: 1200px;
      width: calc(100% - 32px);
      margin: 18px auto 32px;
      padding: 0 0 18px;
      min-height: 100vh;
      background: transparent;
    }

    .tsheet-header {
      display: flex;
      align-items: center;
      padding: 18px 24px;
      background: linear-gradient(135deg, #f6f4ec 0%, #e6ecd6 100%);
      border: 1px solid var(--ucc-border);
      border-radius: 20px;
      box-shadow: var(--ucc-shadow);
      gap: 16px;
    }

    .club-logo {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid var(--ucc-border);
      object-fit: cover;
    }

    .back-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: #ffffff;
      border-radius: 12px;
      font-size: 22px;
      color: var(--ucc-olive-dark);
      cursor: pointer;
      padding: 0;
      box-shadow: 0 6px 14px rgba(31, 42, 27, 0.12);
    }

    .header-info {
      margin-left: 4px;
    }

    .club-name {
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--ucc-muted);
      margin: 0;
    }

    .page-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--ucc-ink);
      margin: 0;
    }

    .selectors {
      display: flex;
      gap: 15px;
      padding: 18px 6px 8px;
    }

    .selector-btn {
      flex: 1;
      padding: 16px 18px;
      border: 1px solid var(--ucc-border);
      border-radius: 16px;
      background: var(--ucc-card);
      cursor: pointer;
      text-align: center;
      box-shadow: 0 8px 20px rgba(31, 42, 27, 0.08);
    }

    .selector-btn.active {
      border-color: var(--ucc-olive);
      box-shadow: 0 8px 20px rgba(90, 122, 58, 0.2);
    }

    .selector-btn .main-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--ucc-olive-dark);
    }

    .selector-btn .sub-text {
      font-size: 12px;
      color: var(--ucc-muted);
    }

    .booking-window-banner {
      margin: 10px 6px 2px;
      padding: 10px 14px;
      background: #f3f7ea;
      border: 1px solid var(--ucc-border);
      border-radius: 14px;
      font-size: 13px;
      color: var(--ucc-olive-dark);
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .booking-window-banner span {
      font-weight: 700;
    }

    .sheet-actions {
      display: flex;
      gap: 12px;
      padding: 4px 6px 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 10px 18px;
      border-radius: 14px;
      border: 1px solid var(--ucc-border);
      background: #fff;
      color: var(--ucc-olive-dark);
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(31, 42, 27, 0.08);
    }

    .action-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .action-btn.primary {
      background: var(--ucc-olive);
      color: #fff;
      border-color: var(--ucc-olive);
    }

    .action-btn.ghost {
      background: #fff;
      border-style: dashed;
      color: var(--ucc-olive-dark);
    }

    .action-note {
      font-size: 12px;
      color: var(--ucc-muted);
      margin-left: auto;
    }

    .table-wrap {
      border-radius: 18px;
      border: 1px solid var(--ucc-border);
      background: #fff;
      overflow: hidden;
      box-shadow: 0 14px 30px rgba(31, 42, 27, 0.08);
    }

    .sheet-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .sheet-table th {
      background: #f3f7ea;
      color: var(--ucc-olive-dark);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid var(--ucc-border);
    }

    .sheet-table thead th {
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .sheet-table td {
      padding: 12px;
      border-bottom: 1px solid #edf0e4;
      vertical-align: top;
      background: #fff;
    }

    .time-col {
      width: 110px;
      font-weight: 700;
      color: var(--ucc-ink);
      font-size: 15px;
    }

    .tee-col {
      width: 70px;
      font-weight: 700;
      color: var(--ucc-olive-dark);
    }

    .slot-card {
      border-radius: 12px;
      border: 1px solid var(--ucc-border);
      padding: 10px 12px;
      background: #fafbf7;
      min-height: 70px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .slot-card.open {
      background: #f6f4ec;
      cursor: pointer;
    }

    .slot-card.booked {
      background: #fffaf0;
      border-color: #e1d8b5;
      cursor: pointer;
    }

    .slot-card.checked-in {
      background: #eef6ea;
      border-color: var(--ucc-olive);
      cursor: pointer;
    }

    .slot-card.no-show {
      background: #f9e2d0;
      border-color: var(--ucc-orange);
    }

    .slot-card.cancelled {
      background: #f1f2f0;
      border-color: #d1d6cf;
    }

    .slot-card.closed {
      background: #f7f7f4;
      border-style: dashed;
      color: #9aa391;
    }

    .slot-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .slot-status {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--ucc-muted);
      font-weight: 700;
    }

    .slot-status.checked-in {
      color: var(--ucc-olive);
    }

    .slot-status.no-show {
      color: #9a4a00;
    }

    .slot-status.cancelled {
      color: #7d827c;
    }

    .slot-name {
      font-weight: 700;
      color: var(--ucc-ink);
      font-size: 14px;
    }

    .slot-meta {
      font-size: 12px;
      color: var(--ucc-muted);
    }

    .slot-action {
      margin-top: auto;
      align-self: flex-start;
      font-size: 12px;
      font-weight: 700;
      color: var(--ucc-olive-dark);
      text-decoration: underline;
    }

    .empty-row td {
      padding: 28px;
      background: #fbfbf7;
    }

    .empty-state {
      padding: 32px;
      border-radius: 16px;
      border: 1px dashed var(--ucc-border);
      text-align: center;
      color: var(--ucc-muted);
      background: rgba(255, 255, 255, 0.7);
    }

    .empty-state h3 {
      margin: 0 0 8px;
      color: var(--ucc-olive-dark);
    }

    .empty-state p {
      margin: 0 0 18px;
    }

    .tee-card-list {
      display: none;
      gap: 12px;
    }

    .tee-card {
      border: 1px solid var(--ucc-border);
      border-radius: 16px;
      padding: 14px;
      background: #fff;
      box-shadow: var(--ucc-shadow);
      display: grid;
      gap: 10px;
    }

    .tee-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tee-card-header .time {
      font-weight: 700;
      font-size: 16px;
    }

    .tee-card-header .tee {
      font-weight: 700;
      color: var(--ucc-olive-dark);
      font-size: 13px;
    }

    .tee-card-slots {
      display: grid;
      gap: 8px;
    }

    .tee-slot {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--ucc-border);
      background: #fafbf7;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .tee-slot.open { cursor: pointer; background: #f6f4ec; }
    .tee-slot.booked { background: #fffaf0; border-color: #e1d8b5; }
    .tee-slot.checked-in { background: #eef6ea; border-color: var(--ucc-olive); }
    .tee-slot.no-show { background: #f9e2d0; border-color: var(--ucc-orange); }
    .tee-slot.cancelled { background: #f1f2f0; border-color: #d1d6cf; }
    .tee-slot.closed { color: #9aa391; }

    .tee-slot .label {
      font-weight: 700;
    }

	    .tee-slot .meta {
	      color: var(--ucc-muted);
	      font-size: 12px;
	    }

	    /* ------------------------------------------------------------------
	       Player View: Compact / Professional
	       ------------------------------------------------------------------ */
	    body.player {
	      font-family: "Aptos", "Segoe UI Variable Text", "Segoe UI", system-ui, -apple-system, sans-serif;
	    }

	    body.player:not(.embedded) {
	      background: linear-gradient(180deg, #f8f6ef 0%, #eef2e4 35%, #f8f6ef 100%);
	    }

	    body.player .tsheet-header {
	      padding: 14px 16px;
	      border-radius: 18px;
	      box-shadow: 0 10px 24px rgba(31, 42, 27, 0.10);
	    }

	    body.player .page-title {
	      font-size: 18px;
	    }

	    body.player .selectors {
	      gap: 10px;
	      padding: 14px 6px 8px;
	    }

	    body.player .selector-btn {
	      padding: 12px 14px;
	      border-radius: 14px;
	      box-shadow: 0 8px 18px rgba(31, 42, 27, 0.06);
	    }

	    body.player .selector-btn .main-text {
	      font-size: 16px;
	    }

	    body.player .selector-btn .sub-text {
	      font-size: 11px;
	    }

	    body.player .booking-window-banner {
	      margin: 8px 6px 2px;
	      padding: 0 6px;
	      border: none;
	      background: transparent;
	      box-shadow: none;
	      font-size: 12px;
	    }

	    body.player .sheet-actions {
	      gap: 8px;
	      padding: 4px 6px 10px;
	    }

	    body.player .action-btn {
	      padding: 8px 12px;
	      border-radius: 12px;
	      font-size: 12px;
	      box-shadow: 0 6px 14px rgba(31, 42, 27, 0.06);
	    }

	    /* Players always use the card layout (table is too bulky). */
	    body.player .table-wrap {
	      display: none;
	    }

	    body.player .tee-card-list {
	      display: flex;
	      flex-direction: column;
	      gap: 10px;
	    }

	    body.player .tee-card {
	      border-radius: 14px;
	      padding: 12px 14px;
	      box-shadow: 0 12px 26px rgba(31, 42, 27, 0.08);
	      display: flex;
	      align-items: center;
	      justify-content: space-between;
	      gap: 14px;
	    }

	    body.player .tee-card-header {
	      display: flex;
	      flex-direction: column;
	      gap: 2px;
	      min-width: 110px;
	    }

	    body.player .tee-card-header .time {
	      font-size: 15px;
	    }

	    body.player .tee-card-header .tee {
	      font-size: 11px;
	      text-transform: uppercase;
	      letter-spacing: 0.08em;
	      color: var(--ucc-muted);
	    }

	    .tee-chip-grid {
	      display: grid;
	      grid-template-columns: repeat(4, minmax(0, 1fr));
	      gap: 8px;
	    }

	    body.player .tee-chip-grid {
	      width: min(340px, 100%);
	    }

	    .tee-chip {
	      appearance: none;
	      border: 1px solid var(--ucc-border);
	      border-radius: 14px;
	      padding: 10px 10px;
	      background: #fff;
	      color: var(--ucc-ink);
	      text-align: center;
	      cursor: pointer;
	      box-shadow: 0 8px 18px rgba(31, 42, 27, 0.06);
	      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
	      display: grid;
	      gap: 4px;
	      min-height: 54px;
	    }

	    body.player .tee-chip {
	      padding: 8px 8px;
	      border-radius: 12px;
	      min-height: 46px;
	    }

	    .tee-chip .num {
	      font-weight: 800;
	      font-size: 14px;
	      letter-spacing: 0.02em;
	    }

	    .tee-chip .tag {
	      font-size: 11px;
	      color: var(--ucc-muted);
	      text-transform: uppercase;
	      letter-spacing: 0.08em;
	    }

	    body.player .tee-chip .tag {
	      font-size: 10px;
	    }

	    .tee-chip.open {
	      background: #ffffff;
	      border-color: rgba(90, 122, 58, 0.45);
	    }

	    .tee-chip.open:hover {
	      border-color: var(--ucc-olive);
	      box-shadow: 0 12px 26px rgba(31, 42, 27, 0.10);
	      transform: translateY(-1px);
	    }

	    .tee-chip.booked {
	      background: #f5f5f2;
	      border-color: #d8ddd6;
	      cursor: default;
	      box-shadow: none;
	    }

	    .tee-chip.closed {
	      background: #f7f7f4;
	      border-style: dashed;
	      color: #9aa391;
	      cursor: default;
	      box-shadow: none;
	    }

	    .tee-chip:disabled {
	      opacity: 0.9;
	    }

	    @media (max-width: 560px) {
	      body.player .tee-card {
	        flex-wrap: wrap;
	        align-items: flex-start;
	      }

	      body.player .tee-chip-grid {
	        width: 100%;
	      }
	    }


	    .sheet-actions {
	      display: flex;
	      gap: 12px;
	      padding: 4px 6px 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 10px 18px;
      border-radius: 14px;
      border: 1px solid var(--ucc-border);
      background: #fff;
      color: var(--ucc-olive-dark);
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(31, 42, 27, 0.08);
    }

    .action-btn.primary {
      background: var(--ucc-olive);
      color: #fff;
      border-color: var(--ucc-olive);
    }

    .action-btn.ghost {
      background: #fff;
      border-style: dashed;
      color: var(--ucc-olive-dark);
    }

    .action-note {
      font-size: 12px;
      color: var(--ucc-muted);
      margin-left: auto;
    }

    .empty-state {
      padding: 36px 28px;
      border-radius: 18px;
      border: 1px dashed var(--ucc-border);
      text-align: center;
      color: var(--ucc-muted);
      background: rgba(255, 255, 255, 0.7);
    }

    .empty-state h3 {
      margin: 0 0 8px;
      color: var(--ucc-olive-dark);
    }

    .empty-state p {
      margin: 0 0 18px;
    }

      font-size: 12px;
      color: var(--ucc-muted);
    }

    .column-headers {
      display: flex;
      padding: 16px 20px;
      border-bottom: 2px solid var(--ucc-olive-dark);
      gap: 20px;
      align-items: center;
      margin-top: 10px;
    }

     .time-header {
       width: 100px;
       font-size: 13px;
       font-weight: 700;
       color: var(--ucc-olive-dark);
       text-align: left;
     }

     .players-header {
       flex: 1;
       text-align: center;
       font-size: 13px;
       font-weight: 700;
       color: var(--ucc-olive-dark);
     }

    .status-legend {
      display: flex;
      gap: 16px;
      padding: 8px 20px 6px;
      font-size: 12px;
      color: var(--ucc-muted);
      align-items: center;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid var(--ucc-border);
      background: #fff;
    }

    .legend-dot.booked { background: #f6f4ec; border-color: var(--ucc-olive); }
    .legend-dot.checked-in { background: var(--ucc-olive); border-color: var(--ucc-olive); }
    .legend-dot.no-show { background: #f9e2d0; border-color: var(--ucc-orange); }
    .legend-dot.cancelled { background: #eef0ea; border-color: #cbd3d9; }

    .tee-times-list {
      padding: 6px 20px 20px;
      overflow-y: auto;
      max-height: calc(100vh - 320px);
    }

    .tee-time-row {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      min-height: 45px;
      gap: 30px;
      padding: 14px 16px;
      border: 1px solid var(--ucc-border);
      border-radius: 16px;
      background: var(--ucc-card);
      box-shadow: 0 10px 26px rgba(31, 42, 27, 0.08);
    }

    .tee-time-label {
      width: 100px;
      font-size: 16px;
      font-weight: 700;
      color: var(--ucc-ink);
      text-align: left;
    }

    .player-slots {
      display: flex;
      flex: 1;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .player-slot {
      width: 45px;
      height: 45px;
      padding: 0;
      border: 1px solid var(--ucc-border);
      border-radius: 12px;
      background: #fff;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--ucc-muted);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .player-slot:hover {
      border-color: var(--ucc-olive);
      background: #f3f7ea;
      color: var(--ucc-olive-dark);
    }

    .player-slot.booked {
      background: #f6f4ec;
      color: var(--ucc-olive-dark);
      border-color: var(--ucc-olive);
      font-weight: 700;
    }

    .player-slot.checked-in {
      background: var(--ucc-olive);
      color: #fff;
      border-color: var(--ucc-olive);
      font-weight: 700;
    }

    .player-slot.no-show {
      background: #f9e2d0;
      color: #9a4a00;
      border-color: var(--ucc-orange);
      font-weight: 700;
    }

    .player-slot.cancelled {
      background: #eef0ea;
      color: #8a8f98;
      border-color: #cbd3d9;
      font-weight: 600;
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 18px;
      padding: 25px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--ucc-shadow);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--ucc-ink);
    }

    .modal-close {
      width: 30px;
      height: 30px;
      border: none;
      background: #f3f3ef;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      color: var(--ucc-muted);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      color: var(--ucc-muted);
      margin-bottom: 5px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--ucc-border);
      border-radius: 10px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .price-display {
      font-size: 20px;
      font-weight: 700;
      color: var(--ucc-olive-dark);
      text-align: center;
      padding: 15px;
      background: #f3f7ea;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .modal-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: var(--ucc-olive);
      color: #fff;
    }

    .btn-secondary {
      background: #f3f3ef;
      color: var(--ucc-ink);
    }

    .btn-danger {
      background: #b23a2b;
      color: #fff;
    }

    .btn-success {
      background: var(--ucc-olive);
      color: #fff;
    }

    /* Date picker modal */
    .date-picker-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 20px;
    }

    .date-picker-day {
      padding: 10px 5px;
      text-align: center;
      border: 1px solid var(--ucc-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
    }

    .date-picker-day:hover {
      background: #f3f7ea;
      border-color: var(--ucc-olive);
    }

    .date-picker-day.selected {
      background: var(--ucc-olive);
      color: #fff;
      border-color: var(--ucc-olive);
    }

    .date-picker-day.today {
      border-color: var(--ucc-olive);
      font-weight: 600;
    }

    .holes-selector {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .holes-option {
      padding: 15px 30px;
      border: 2px solid var(--ucc-border);
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
    }

    .holes-option:hover,
    .holes-option.selected {
      border-color: var(--ucc-olive);
      background: #f3f7ea;
    }

    .holes-option .number {
      font-size: 24px;
      font-weight: 700;
      color: var(--ucc-olive-dark);
    }

    .holes-option .label {
      font-size: 12px;
      color: var(--ucc-muted);
    }

    @media (max-width: 860px) {
      .selectors {
        flex-direction: column;
      }

      .tee-time-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .tee-time-label {
        width: auto;
      }

      .player-slots {
        justify-content: flex-start;
      }

      .table-wrap {
        display: none;
      }

	      .tee-card-list {
	        display: grid;
	      }

	      body.player .tee-card-list {
	        grid-template-columns: 1fr;
	      }
	    }
	  </style>
</head>
<body>
  <div class="tsheet-container">
    <div class="tsheet-header">
      <button class="back-btn" onclick="history.back()">&lsaquo;</button>
      <img class="club-logo" src="/frontend/assets/logo.jpeg" alt="Umhlali Country Club">
      <div class="header-info">
        <p class="club-name">Umhlali Country Club</p>
        <h1 class="page-title">Tee Sheet Overview</h1>
      </div>
    </div>
    
    <div class="selectors">
      <button class="selector-btn" onclick="openDatePicker()">
        <div class="main-text" id="selected-day">Today</div>
        <div class="sub-text" id="selected-date"></div>
      </button>
      <button class="selector-btn" onclick="openHolesPicker()">
        <div class="main-text" id="selected-holes">18</div>
        <div class="sub-text">Holes</div>
      </button>
    </div>

    <div class="booking-window-banner" id="booking-window-banner">
      <span id="booking-window-label">Booking window: --</span>
      <span id="booking-window-range"></span>
    </div>

    
    <div class="sheet-actions">
      <span class="non-embed admin-only">
        <button class="action-btn primary" id="generate-btn" onclick="generateTeeSheet()">Generate Day Tee Sheet</button>
        <button class="action-btn ghost" onclick="openAddTeeTimeModal()">Add Single Tee Time</button>
      </span>
      <button class="action-btn" id="earlier-btn" onclick="viewEarlier()">View Earlier</button>
      <button class="action-btn" id="later-btn" onclick="viewLater()">View Later</button>
      <span class="action-note" id="page-info">Showing 0–0</span>
    </div>

    <div class="table-wrap">
      <table class="sheet-table">
        <thead>
          <tr>
            <th class="time-col">Time</th>
            <th class="tee-col">Tee</th>
            <th>Player 1</th>
            <th>Player 2</th>
            <th>Player 3</th>
            <th>Player 4</th>
          </tr>
        </thead>
        <tbody id="tee_times_list">
          <!-- Tee times will be loaded here -->
        </tbody>
      </table>
    </div>

    <div class="tee-card-list" id="tee_cards_list"></div>
  </div>

  <!-- Booking Modal -->
  <div class="modal-overlay" id="bookingModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title" id="modalTitle">Book Slot</span>
        <button class="modal-close" onclick="closeModal('bookingModal')">&times;</button>
      </div>
      <div id="modalBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <!-- Date Picker Modal -->
  <div class="modal-overlay" id="datePickerModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Select Date</span>
        <button class="modal-close" onclick="closeModal('datePickerModal')">&times;</button>
      </div>
      <div id="datePickerBody">
        <!-- Calendar will be rendered here -->
      </div>
    </div>
  </div>

  <!-- Holes Picker Modal -->
  <div class="modal-overlay" id="holesPickerModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Select Holes</span>
        <button class="modal-close" onclick="closeModal('holesPickerModal')">&times;</button>
      </div>
      <div class="holes-selector">
        <div class="holes-option" onclick="selectHoles(9)">
          <div class="number">9</div>
          <div class="label">Holes</div>
        </div>
        <div class="holes-option selected" onclick="selectHoles(18)">
          <div class="number">18</div>
          <div class="label">Holes</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Tee Time Modal -->
  <div class="modal-overlay admin-only" id="addTeeTimeModal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Add New Tee Time</span>
        <button class="modal-close" onclick="closeModal('addTeeTimeModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>Select Time</label>
        <input type="time" id="new_tee_time" step="600">
      </div>
      <button class="modal-btn btn-primary" onclick="createTeeTime()">Create Tee Time</button>
    </div>
  </div>

<script>
const API_PREFIX = '/tsheet';
const token = localStorage.getItem('token');
if(!token) location.href='/frontend/index.html';
const role = localStorage.getItem('user_role') || 'player';
const isAdmin = role === 'admin';
document.body.classList.add(isAdmin ? 'admin' : 'player');

let selectedDate = new Date();
let bookingWindowDays = 14;
let bookingWindowMaxDate = null;
let bookingWindowType = 'visitor';

const typeLabels = {
  member: 'Umhlali Member',
  visitor: 'Affiliated Visitor',
  non_affiliated: 'Visitor (No HNA)'
};

const params = new URLSearchParams(window.location.search);
const isEmbedded = params.get('embedded') === '1';
const dateParam = params.get('date');
if (dateParam) {
  selectedDate = new Date(`${dateParam}T00:00:00`);
}
if (isEmbedded) {
  document.body.classList.add('embedded');
}

let selectedHoles = 18;
let allTeeTimes = [];
let golfFees = [];
let autoGeneratedDates = {};
let pageStartIndex = 0;
const PAGE_SIZE = 10;

const DEFAULT_START = "06:30";
const DEFAULT_END = "16:30";
const DEFAULT_INTERVAL_MIN = 10;


// Format time for display


function buildDateTime(baseDate, timeStr) {
  const [h, m] = timeStr.split(':');
  const d = new Date(baseDate);
  d.setHours(parseInt(h), parseInt(m), 0, 0);
  return d;
}

function dateToYMD(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function buildRangeForDay(date) {
  const startYMD = dateToYMD(date);
  const nextDay = new Date(date);
  nextDay.setDate(nextDay.getDate() + 1);
  const endYMD = dateToYMD(nextDay);
  return {
    start: `${startYMD}T00:00:00`,
    end: `${endYMD}T00:00:00`
  };
}

function formatBannerDate(date) {
  try {
    return new Date(date).toLocaleDateString('en-GB');
  } catch (e) {
    return '';
  }
}

function updateBookingWindowBanner() {
  const labelEl = document.getElementById('booking-window-label');
  const rangeEl = document.getElementById('booking-window-range');
  if (!labelEl || !rangeEl) return;
  const label = typeLabels[bookingWindowType] || 'Visitor';
  labelEl.textContent = `Booking window: ${bookingWindowDays} days (${label})`;
  if (bookingWindowMaxDate) {
    rangeEl.textContent = `Book through ${formatBannerDate(bookingWindowMaxDate)}`;
  } else {
    rangeEl.textContent = '';
  }
}

async function loadBookingWindow() {
  try {
    const res = await fetch('/settings/booking-window', { headers: { 'Authorization': 'Bearer ' + token }});
    if (!res.ok) return;
    const data = await res.json();
    bookingWindowDays = Number.isFinite(data.window_days) ? data.window_days : bookingWindowDays;
    bookingWindowType = data.player_type || bookingWindowType;
    if (data.max_date) {
      bookingWindowMaxDate = new Date(`${data.max_date}T00:00:00`);
    }
    if (!isAdmin && bookingWindowMaxDate && selectedDate > bookingWindowMaxDate) {
      selectedDate = new Date(bookingWindowMaxDate);
      updateDateDisplay();
    }
    updateBookingWindowBanner();
  } catch (e) {
    // Non-blocking
  }
}

function floorToInterval(dateObj, intervalMin) {
  const d = new Date(dateObj);
  const mins = d.getMinutes();
  d.setSeconds(0, 0);
  d.setMinutes(Math.floor(mins / intervalMin) * intervalMin);
  return d;
}

function isPastTeeTime(teeTimeIso) {
  const today0 = new Date();
  today0.setHours(0, 0, 0, 0);

  const selected0 = new Date(selectedDate);
  selected0.setHours(0, 0, 0, 0);

  // Past days: all times closed. Future days: all open.
  if (selected0.getTime() < today0.getTime()) return true;
  if (selected0.getTime() > today0.getTime()) return false;

  // Today: closed if earlier than current interval floor (e.g. 11:05 => 11:00).
  const threshold = floorToInterval(new Date(), DEFAULT_INTERVAL_MIN);
  return new Date(teeTimeIso) < threshold;
}

async function createTeeTimeAt(teeDateTime) {
  const res = await fetch(API_PREFIX + '/create', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ tee_time: teeDateTime.toISOString() })
  });
  return res.ok;
}

function formatTime(date) {
  const d = new Date(date);
  let hours = d.getHours();
  let minutes = d.getMinutes();
  return `${hours}:${minutes.toString().padStart(2, '0')}`;
}

// Format date for display
function formatDateDisplay(date) {
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  
  const today = new Date();
  today.setHours(0,0,0,0);
  const checkDate = new Date(date);
  checkDate.setHours(0,0,0,0);
  
  const dayName = days[date.getDay()];
  const dd = String(date.getDate()).padStart(2, '0');
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const yy = String(date.getFullYear()).slice(2);
  const dateStr = `${dd}/${mm}/${yy}`;
  
  if (checkDate.getTime() === today.getTime()) {
    return { day: 'Today', date: dateStr };
  }
  
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  if (checkDate.getTime() === tomorrow.getTime()) {
    return { day: 'Tomorrow', date: dateStr };
  }
  
  return { day: dayName, date: dateStr };
}

// Update date display
function updateDateDisplay() {
  const display = formatDateDisplay(selectedDate);
  document.getElementById('selected-day').textContent = display.day;
  document.getElementById('selected-date').textContent = display.date;
}

// Load golf fees
async function loadFees() {
  try {
    const res = await fetch('/fees/golf', { headers: { 'Authorization': 'Bearer ' + token }});
    if (res.ok) {
      golfFees = await res.json();
    }
  } catch(e) {
    console.error('Failed to load fees:', e);
  }
}

// Load tee times
async function loadTeeTimes() {
  try {
    if (!isAdmin && bookingWindowMaxDate && selectedDate > bookingWindowMaxDate) {
      const container = document.getElementById('tee_times_list');
      if (container) {
        container.innerHTML = `
          <tr class="empty-row">
            <td colspan="6">
              <div class="empty-state">
                <h3>Outside your booking window</h3>
                <p>Bookings are limited to ${bookingWindowDays} days ahead.</p>
              </div>
            </td>
          </tr>
        `;
      }
      const cards = document.getElementById('tee_cards_list');
      if (cards) {
        cards.innerHTML = `
          <div class="empty-state">
            <h3>Outside your booking window</h3>
            <p>Bookings are limited to ${bookingWindowDays} days ahead.</p>
          </div>
        `;
      }
      updatePagerInfo(0, 0);
      return;
    }
    const range = buildRangeForDay(selectedDate);
    const qs = `?start=${encodeURIComponent(range.start)}&end=${encodeURIComponent(range.end)}`;
    const res = await fetch(API_PREFIX + '/range' + qs, { headers: { 'Authorization': 'Bearer ' + token }});
    allTeeTimes = res.ok ? await res.json() : [];
    resetPageStartIndex();
    renderTeeTimes();
  } catch(e) {
    console.error('Failed to load tee times:', e);
  }
}

function resetPageStartIndex() {
  const list = Array.isArray(allTeeTimes) ? allTeeTimes : [];
  if (list.length === 0) {
    pageStartIndex = 0;
    return;
  }

  // Default: start at beginning for non-today dates.
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const checkDate = new Date(selectedDate);
  checkDate.setHours(0, 0, 0, 0);
  if (checkDate.getTime() !== today.getTime()) {
    pageStartIndex = 0;
    return;
  }

  const threshold = floorToInterval(new Date(), DEFAULT_INTERVAL_MIN);
  let idx = list.findIndex(tt => new Date(tt.tee_time) >= threshold);
  if (idx < 0) idx = Math.max(0, list.length - PAGE_SIZE);
  const maxStart = Math.max(0, list.length - PAGE_SIZE);
  pageStartIndex = Math.min(Math.max(0, idx), maxStart);
}

function updatePagerInfo(total, shown) {
  const info = document.getElementById('page-info');
  const earlier = document.getElementById('earlier-btn');
  const later = document.getElementById('later-btn');
  if (!info || !earlier || !later) return;

  if (total === 0) {
    info.textContent = 'No tee times';
    earlier.disabled = true;
    later.disabled = true;
    return;
  }

  const start = Math.min(total, pageStartIndex + 1);
  const end = Math.min(total, pageStartIndex + shown);
  info.textContent = `Showing ${start}\u2013${end} of ${total}`;

  earlier.disabled = pageStartIndex <= 0;
  later.disabled = pageStartIndex + shown >= total;
}

function viewEarlier() {
  pageStartIndex = Math.max(0, pageStartIndex - PAGE_SIZE);
  renderTeeTimes();
}

function viewLater() {
  const total = Array.isArray(allTeeTimes) ? allTeeTimes.length : 0;
  const maxStart = Math.max(0, total - PAGE_SIZE);
  pageStartIndex = Math.min(maxStart, pageStartIndex + PAGE_SIZE);
  renderTeeTimes();
}

	// Render tee times for selected date
	function renderTeeTimes() {
	  const container = document.getElementById('tee_times_list');
	  
	  const dateStr = dateToYMD(selectedDate);
  const dayTeeTimes = (Array.isArray(allTeeTimes) ? allTeeTimes : [])
    .slice()
    .sort((a, b) => {
      const ta = new Date(a.tee_time).getTime();
      const tb = new Date(b.tee_time).getTime();
      if (ta !== tb) return ta - tb;
      const ha = parseInt(a.hole || '1', 10);
      const hb = parseInt(b.hole || '1', 10);
      return ha - hb;
    });
  
	  const renderTable = isAdmin; // avoid leaking names/prices in player view
	  let html = '';
	  let cardsHtml = '';

  if (dayTeeTimes.length === 0) {
    updatePagerInfo(0, 0);
    if (isAdmin && !autoGeneratedDates[dateStr]) {
      autoGeneratedDates[dateStr] = true;
      container.innerHTML = `
        <tr class="empty-row">
          <td colspan="6">
            <div class="empty-state">
              <h3>Generating tee sheet...</h3>
              <p>Creating 10-minute intervals for today.</p>
            </div>
          </td>
        </tr>
      `;
      generateTeeSheet();
      const cards = document.getElementById('tee_cards_list');
      if (cards) {
        cards.innerHTML = `
          <div class="empty-state">
            <h3>Generating tee sheet...</h3>
            <p>Creating 10-minute intervals for today.</p>
          </div>
        `;
      }
      return;
    }

    container.innerHTML = `
      <tr class="empty-row">
        <td colspan="6">
          <div class="empty-state">
            <h3>No tee times for this day</h3>
            <p>${isAdmin ? "Generate the day sheet or add a single time to get started." : "Please contact the pro shop to open tee times."}</p>
            ${isAdmin ? '<button class="action-btn primary" onclick="generateTeeSheet()">Generate Day Tee Sheet</button>' : ''}
          </div>
        </td>
      </tr>
    `;
    const cards = document.getElementById('tee_cards_list');
    if (cards) {
      cards.innerHTML = `
        <div class="empty-state">
          <h3>No tee times for this day</h3>
          <p>${isAdmin ? "Generate the day sheet or add a single time to get started." : "Please contact the pro shop to open tee times."}</p>
          ${isAdmin ? '<button class="action-btn primary" onclick="generateTeeSheet()">Generate Day Tee Sheet</button>' : ''}
        </div>
      `;
    }
    return;
  }

  const maxStart = Math.max(0, dayTeeTimes.length - PAGE_SIZE);
  pageStartIndex = Math.min(Math.max(0, pageStartIndex), maxStart);
  const page = dayTeeTimes.slice(pageStartIndex, pageStartIndex + PAGE_SIZE);
  updatePagerInfo(dayTeeTimes.length, page.length);
  
	  page.forEach(tt => {
	    const time = formatTime(tt.tee_time);
	    const teeLabel = tt.hole ? tt.hole : '1';
	    const bookings = Array.isArray(tt.bookings) ? tt.bookings : [];
	    const capacity = tt.capacity || 4;

	    if (renderTable) {
	      html += `
	        <tr>
	          <td class="time-col">${time}</td>
	          <td class="tee-col">${teeLabel}</td>
	      `;
	    }

	    const isPlayerView = !isAdmin;
	    if (isPlayerView) {
	      cardsHtml += `
	        <div class="tee-card">
	          <div class="tee-card-header">
	            <div class="time">${time}</div>
	            <div class="tee">Tee ${teeLabel}</div>
	          </div>
	          <div class="tee-chip-grid">
	      `;
	    } else {
	      cardsHtml += `
	        <div class="tee-card">
	          <div class="tee-card-header">
	            <div class="time">${time}</div>
	            <div class="tee">Tee ${teeLabel}</div>
	          </div>
	          <div class="tee-card-slots">
	      `;
	    }

	    for (let i = 0; i < 4; i++) {
	      const slotNumber = i + 1;
	      if (i >= capacity) {
	        if (renderTable) {
	          html += `
	            <td>
	              <div class="slot-card closed">
	                <div class="slot-top"><span class="slot-status">Closed</span></div>
	                <div class="slot-name">Not available</div>
	              </div>
	            </td>
	          `;
	        }
	        if (isPlayerView) {
	          cardsHtml += `
	            <button type="button" class="tee-chip closed" disabled>
	              <div class="num">${slotNumber}</div>
	              <div class="tag">Closed</div>
	            </button>
	          `;
	        } else {
	          cardsHtml += `
	            <div class="tee-slot closed">
	              <div>
	                <div class="label">Slot ${slotNumber}</div>
	                <div class="meta">Closed</div>
	              </div>
	            </div>
	          `;
	        }
	        continue;
	      }

	      const booking = bookings[i];
	      if (booking) {
	        const status = booking.status || 'booked';
	        const statusClass = status === 'checked_in' ? 'checked-in' : status === 'no_show' ? 'no-show' : status === 'cancelled' ? 'cancelled' : status === 'completed' ? 'checked-in' : 'booked';
	        const statusLabel = status.replace('_', ' ');
	        if (renderTable) {
	          html += `
	            <td>
	              <div class="slot-card ${statusClass}" onclick="openBookingDetails(${tt.id}, ${booking.id})">
	                <div class="slot-top"><span class="slot-status ${statusClass}">${statusLabel}</span></div>
	                <div class="slot-name">${booking.player_name}</div>
	                <div class="slot-meta">R${booking.price}</div>
	              </div>
	            </td>
	          `;
	        }
	        if (isPlayerView) {
	          const tag = (status === 'checked_in' || status === 'completed') ? 'Checked in' : 'Booked';
	          cardsHtml += `
	            <button type="button" class="tee-chip booked" disabled>
	              <div class="num">${slotNumber}</div>
	              <div class="tag">${tag}</div>
	            </button>
	          `;
	        } else {
	          cardsHtml += `
	            <div class="tee-slot ${statusClass}" onclick="openBookingDetails(${tt.id}, ${booking.id})">
	              <div>
	                <div class="label">${booking.player_name}</div>
	                <div class="meta">${statusLabel}</div>
	              </div>
	              <div class="meta">R${booking.price}</div>
	            </div>
	          `;
	        }
	      } else {
	        if (isPastTeeTime(tt.tee_time)) {
	          if (renderTable) {
	            html += `
	              <td>
	                <div class="slot-card closed">
	                  <div class="slot-top"><span class="slot-status">Closed</span></div>
	                  <div class="slot-name">Past time</div>
	                </div>
	              </td>
	            `;
	          }
	          if (isPlayerView) {
	            cardsHtml += `
	              <button type="button" class="tee-chip closed" disabled>
	                <div class="num">${slotNumber}</div>
	                <div class="tag">Closed</div>
	              </button>
	            `;
	          } else {
	            cardsHtml += `
	              <div class="tee-slot closed">
	                <div>
	                  <div class="label">Slot ${slotNumber}</div>
	                  <div class="meta">Past time</div>
	                </div>
	              </div>
	            `;
	          }
	        } else {
	          if (renderTable) {
	            html += `
	              <td>
	                <div class="slot-card open" onclick="openBookingForm(${tt.id}, ${slotNumber})">
	                  <div class="slot-top"><span class="slot-status">Open</span></div>
	                  <div class="slot-name">Available</div>
	                  <div class="slot-action">Add player</div>
	                </div>
	              </td>
	            `;
	          }
	          if (isPlayerView) {
	            cardsHtml += `
	              <button type="button" class="tee-chip open" onclick="openBookingForm(${tt.id}, ${slotNumber})">
	                <div class="num">${slotNumber}</div>
	                <div class="tag">Open</div>
	              </button>
	            `;
	          } else {
	            cardsHtml += `
	              <div class="tee-slot open" onclick="openBookingForm(${tt.id}, ${slotNumber})">
	                <div>
	                  <div class="label">Slot ${slotNumber}</div>
	                  <div class="meta">Available</div>
	                </div>
	                <div class="meta">Add player</div>
	              </div>
	            `;
	          }
	        }
	      }
	    }

	    if (renderTable) {
	      html += `</tr>`;
	    }
	    cardsHtml += `
	        </div>
	      </div>
	    `;
	  });
  
  container.innerHTML = html;
  const cardContainer = document.getElementById('tee_cards_list');
  if (cardContainer) {
    cardContainer.innerHTML = cardsHtml;
  }
}

// Open modals
function openModal(id) {
  document.getElementById(id).classList.add('active');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

function openDatePicker() {
  renderDatePicker();
  openModal('datePickerModal');
}

function openHolesPicker() {
  openModal('holesPickerModal');
}

function openAddTeeTimeModal() {
  if (!isAdmin) return;
  openModal('addTeeTimeModal');
}

// Render date picker
function renderDatePicker() {
  const container = document.getElementById('datePickerBody');
  const today = new Date();
  const days = [];
  
  const windowCount = Math.max(1, (Number.isFinite(bookingWindowDays) ? bookingWindowDays : 14) + 1);
  for (let i = 0; i < windowCount; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() + i);
    days.push(d);
  }
  
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  
  let html = '<div class="date-picker-grid">';
  
  // Day name headers
  dayNames.forEach(name => {
    html += `<div style="text-align: center; font-size: 11px; color: #888; padding: 5px;">${name}</div>`;
  });
  
  // Add empty cells for alignment
  const firstDayOfWeek = days[0].getDay();
  for (let i = 0; i < firstDayOfWeek; i++) {
    html += '<div></div>';
  }
  
  days.forEach(d => {
    const isToday = d.toDateString() === today.toDateString();
    const isSelected = d.toDateString() === selectedDate.toDateString();
    let classes = 'date-picker-day';
    if (isToday) classes += ' today';
    if (isSelected) classes += ' selected';
    
    html += `<div class="${classes}" onclick="selectDate('${d.toISOString()}')">${d.getDate()}</div>`;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function selectDate(isoString) {
  const nextDate = new Date(isoString);
  if (!isAdmin && bookingWindowMaxDate && nextDate > bookingWindowMaxDate) {
    alert(`Bookings are limited to ${bookingWindowDays} days ahead.`);
    return;
  }
  selectedDate = nextDate;
  updateDateDisplay();
  closeModal('datePickerModal');
  loadTeeTimes();
}

function selectHoles(num) {
  selectedHoles = num;
  document.getElementById('selected-holes').textContent = num;
  document.querySelectorAll('.holes-option').forEach(el => el.classList.remove('selected'));
  event.target.closest('.holes-option').classList.add('selected');
  closeModal('holesPickerModal');
  renderTeeTimes();
}

// Create new tee time
async function createTeeTime() {
  if (!isAdmin) {
    alert('Admin access required.');
    return;
  }
  const timeInput = document.getElementById('new_tee_time').value;
  if (!timeInput) {
    alert('Please select a time');
    return;
  }
  
  const [hours, minutes] = timeInput.split(':');
  const teeDateTime = new Date(selectedDate);
  teeDateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
  
  try {
    const ok = await createTeeTimeAt(teeDateTime);
    if (ok) {
      closeModal('addTeeTimeModal');
      loadTeeTimes();
    } else {
      alert('Failed to create tee time');
    }
  } catch(e) {
    alert('Failed to create tee time');
  }
}

// Open booking page


async function generateTeeSheet() {
  if (!isAdmin) {
    alert('Admin access required.');
    return;
  }
  const button = document.getElementById('generate-btn');
  if (button) {
    button.disabled = true;
    button.textContent = 'Generating...';
  }

  try {
    const start = buildDateTime(selectedDate, DEFAULT_START);
    const end = buildDateTime(selectedDate, DEFAULT_END);
    const interval = DEFAULT_INTERVAL_MIN;

    let created = 0;
    for (let t = new Date(start); t <= end; t = new Date(t.getTime() + interval * 60000)) {
      const ok = await createTeeTimeAt(t);
      if (ok) created++;
    }

    await loadTeeTimes();
    alert(`OK: Generated ${created} tee times`);
  } catch (e) {
    alert('Failed to generate tee times');
  } finally {
    if (button) {
      button.disabled = false;
      button.textContent = 'Generate Day Tee Sheet';
    }
  }
}

function openBookingForm(teeTimeId, slotNumber) {
  const teeTime = allTeeTimes.find(tt => tt.id === teeTimeId);
  if (teeTime) {
    window.location.href = `/frontend/booking.html?tee_time_id=${teeTimeId}&tee_time=${encodeURIComponent(teeTime.tee_time)}`;
  }
}

function updatePriceDisplay() {
  const select = document.getElementById('booking_fee');
  const option = select.options[select.selectedIndex];
  const price = option.getAttribute('data-price');
  
  if (price) {
    document.getElementById('price_display').textContent = `Total: R${price}`;
  } else {
    document.getElementById('price_display').textContent = 'Select a fee type';
  }
}

async function createBooking(teeTimeId) {
  const name = document.getElementById('booking_name').value;
  const email = document.getElementById('booking_email').value;
  const handicap = document.getElementById('booking_handicap').value;
  const feeId = document.getElementById('booking_fee').value;
  
  if (!name) {
    alert('Please enter player name');
    return;
  }
  
  if (!feeId) {
    alert('Please select a fee type');
    return;
  }
  
  try {
    const res = await fetch('/tsheet/booking', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        tee_time_id: teeTimeId,
        player_name: name,
        player_email: email,
        handicap_number: handicap || null,
        fee_category_id: parseInt(feeId)
      })
    });
    
    if (res.ok) {
      closeModal('bookingModal');
      alert('✓ Booking created successfully!');
      loadTeeTimes();
    } else {
      const error = await res.json();
      alert('Booking error: ' + JSON.stringify(error));
    }
  } catch(e) {
    alert('Failed to create booking');
  }
}

	// Open booking details
	async function openBookingDetails(teeTimeId, bookingId) {
	  // Find the booking
	  const teeTime = allTeeTimes.find(tt => tt.id === teeTimeId);
	  const booking = teeTime?.bookings?.find(b => b.id === bookingId);
	  
	  if (!booking) return;

	  if (!isAdmin) {
	    // Player view shouldn't expose other players' details.
	    document.getElementById('modalTitle').textContent = 'Slot booked';
	    document.getElementById('modalBody').innerHTML = `
	      <div style="padding: 15px; background: var(--ucc-cream); border-radius: 10px; margin-bottom: 15px;">
	        <div style="font-size: 16px; font-weight: 700; margin-bottom: 6px;">This slot is not available</div>
	        <div style="font-size: 13px; color: var(--ucc-muted);">Please choose another open slot.</div>
	      </div>
	      <button class="modal-btn btn-secondary" onclick="closeModal('bookingModal')">Close</button>
	    `;
	    openModal('bookingModal');
	    return;
	  }

	  document.getElementById('modalTitle').textContent = 'Booking Details';
	  
	  const isCheckedIn = booking.status === 'checked_in';
  
  document.getElementById('modalBody').innerHTML = `
    <div style="padding: 15px; background: var(--ucc-cream); border-radius: 10px; margin-bottom: 15px;">
      <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">${booking.player_name}</div>
      <div style="font-size: 14px; color: var(--ucc-muted); margin-bottom: 5px;">
        <strong>Status:</strong> ${booking.status.replace('_', ' ')}
      </div>
      <div style="font-size: 14px; color: var(--ucc-muted); margin-bottom: 5px;">
        <strong>Price:</strong> R${booking.price}
      </div>
      ${booking.player_email ? `<div style="font-size: 14px; color: var(--ucc-muted);"><strong>Email:</strong> ${booking.player_email}</div>` : ''}
    </div>
    ${!isCheckedIn ? `<button class="modal-btn btn-success" onclick="checkIn(${bookingId})">Check In</button>` : ''}
    <button class="modal-btn btn-secondary" onclick="closeModal('bookingModal')">Close</button>
  `;
  
  openModal('bookingModal');
}

async function checkIn(bookingId) {
  try {
    const res = await fetch('/checkin/' + bookingId, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    
    if (res.ok) {
      closeModal('bookingModal');
      alert('✓ Checked in successfully!');
      loadTeeTimes();
    } else {
      alert('Check-in failed');
    }
  } catch(e) {
    alert('Check-in failed');
  }
}

// Initialize
(async () => {
  await loadBookingWindow();
  updateDateDisplay();
  await loadFees();
  loadTeeTimes();
})();
</script>
</body>
</html>
