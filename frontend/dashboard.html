<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>GreenLink Dashboard</title>
  <link rel="stylesheet" href="/frontend/style.css">
  <style>
    .profile-section { display: none; }
    .profile-section.active { display: block; }
    .alert { padding: 15px; margin: 15px 0; border-radius: 5px; }
    .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1>Dashboard</h1></div>
    
    <!-- Alert if profile incomplete -->
    <div id="profile_alert" class="alert alert-warning" style="display: none;">
      <strong>Complete Your Profile</strong> - Please update your profile details (phone, date of birth, and home club) before booking tee times.
      <button onclick="toggleProfile()" class="btn btn-sm btn-primary" style="float: right;">Update Profile</button>
    </div>

    <!-- Navigation buttons -->
    <div class="card p-4 mt-3">
      <button onclick="toggleProfile()" class="btn btn-info">My Profile</button>
      <button onclick="goto('tsheet.html')" class="btn btn-primary mt-2">Book Now</button>
      <button onclick="logout()" class="btn btn-danger mt-2">Logout</button>
    </div>

    <!-- Player Profile Section -->
    <div id="profile_section" class="card p-4 mt-4 profile-section">
      <h3>Player Profile</h3>
      <form id="profile_form" onsubmit="saveProfile(event)">
        <div class="form-group mt-3">
          <label>Full Name</label>
          <input type="text" id="profile_name" class="form-control" required>
        </div>
        <div class="form-group mt-3">
          <label>Phone Number</label>
          <input type="tel" id="profile_phone" class="form-control" required>
        </div>
        <div class="form-group mt-3">
          <label>Birth Date</label>
          <input type="date" id="profile_birth_date" class="form-control" required>
        </div>
        <div class="form-group mt-3">
          <label>HNA SA Player ID (optional)</label>
          <input type="text" id="profile_handicap_sa_id" class="form-control" placeholder="e.g., 27XXXXXXXX">
        </div>
        <div class="form-group mt-3">
          <label>Home Club</label>
          <input type="text" id="profile_home_course" class="form-control" placeholder="e.g., Umhlali Country Club" required>
        </div>
        <button type="submit" class="btn btn-success mt-4">Save Profile</button>
        <button type="button" onclick="toggleProfile()" class="btn btn-secondary mt-4 ms-2">Cancel</button>
      </form>
    </div>

    <!-- Welcome Card -->
    <div class="card p-5 mt-5" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; border: none; border-radius: 15px; box-shadow: 0 8px 16px rgba(46, 204, 113, 0.3);">
      <h2 style="margin-bottom: 30px; font-size: 28px;">Welcome, <span id="user_name" style="font-weight: bold;">Player</span>!</h2>
      <div style="font-size: 18px; line-height: 2;">
        <p><strong>Email:</strong> <span id="user_email" style="font-size: 16px;">-</span></p>
        <p><strong>Phone:</strong> <span id="user_phone" style="font-size: 16px;">-</span></p>
        <p><strong>Age:</strong> <span id="user_age" style="font-size: 16px;">-</span></p>
        <p><strong>Handicap SA ID:</strong> <span id="user_handicap_sa" style="font-size: 16px;">-</span></p>
        <p><strong>Home Club:</strong> <span id="user_home_course" style="font-size: 16px;">-</span></p>
      </div>
    </div>
  </div>

<script>
const token = localStorage.getItem('token');

function logout(){ localStorage.removeItem('token'); window.location.href='/frontend/index.html'; }
function goto(p){ window.location.href='/frontend/'+p; }

function toggleProfile(){
  const section = document.getElementById('profile_section');
  section.classList.toggle('active');
}

async function loadUserInfo(){
  if(!token){ window.location.href='/frontend/index.html'; return; }
  
  const res = await fetch('/profile/me', { headers: { 'Authorization': 'Bearer '+token }});
  if(!res.ok){ alert('Session invalid'); logout(); return; }
  const profile = await res.json();
  
  // Display profile info
  document.getElementById('user_name').textContent = profile.name;
  document.getElementById('user_email').textContent = profile.email;
  document.getElementById('user_phone').textContent = profile.phone || 'Not set';
  document.getElementById('user_age').textContent = profile.age || 'Not set';
  document.getElementById('user_handicap_sa').textContent = profile.handicap_sa_id || 'Not set';
  document.getElementById('user_home_course').textContent = profile.home_course || 'Not set';
  
  // Populate form
  document.getElementById('profile_name').value = profile.name;
  if(profile.phone) document.getElementById('profile_phone').value = profile.phone;
  if(profile.birth_date) document.getElementById('profile_birth_date').value = profile.birth_date;
  if(profile.handicap_sa_id) document.getElementById('profile_handicap_sa_id').value = profile.handicap_sa_id;
  if(profile.home_course) document.getElementById('profile_home_course').value = profile.home_course;
  
  // Show alert if profile incomplete
  if(!profile.phone || !profile.birth_date || !profile.home_course){
    document.getElementById('profile_alert').style.display = 'block';
  }
}

async function saveProfile(e){
  e.preventDefault();
  
  const profileData = {
    name: document.getElementById('profile_name').value,
    phone: document.getElementById('profile_phone').value,
    birth_date: document.getElementById('profile_birth_date').value,
    handicap_sa_id: document.getElementById('profile_handicap_sa_id').value,
    home_course: document.getElementById('profile_home_course').value
  };
  
  const res = await fetch('/profile/me', {
    method: 'PUT',
    headers: { 
      'Authorization': 'Bearer '+token,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(profileData)
  });
  
  if(res.ok){
    alert('Profile saved successfully!');
    document.getElementById('profile_section').classList.remove('active');
    loadUserInfo();
  } else {
    alert('Error saving profile');
  }
}

if(!token) window.location.href='/frontend/index.html';
else loadUserInfo();
</script>
</body>
</html>
